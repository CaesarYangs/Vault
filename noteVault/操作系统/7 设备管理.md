讨论设备管理的基本概念，包括中断，缓冲，设备分配和控制等。

# Intro
## 设备的类别
除了 CPU 与内存之外，其它大部分硬设备都称为外部设备。

包括：输入输出设备、外存设备、终端设备。

**按设备使用特性分类**
存储设备、输入输出设备、终端设备、脱机设备等。

**按设备从属关系分类**
系统设备、用户设备

**对设备分类的目的在于简化设备管理程序。因为不同的硬件要对应不同的硬件管理程序，分类后只需做很少的修改就可以实现一类物体的管理。**

## 设备管理的功能和任务
**设备管理是对计算机输入输出系统的管理**
**主要任务：**
- 选择和分配输入输出设备以便进行数据传输操作
- 控制输入输出设备和 CPU（或内存）之间交换数据
- 为用户提供友好透明的接口，将用户和设备硬件特性分开。
- 提高设备之间、CPU 和设备间以及进程之间的并行操作度，是系统获最佳效率

**主要功能：**
- 提供和进程管理系统的接口
- 进行设备分配
- 实现设备间，设备和 CPU 间等之间的并行操作。
- 进行缓冲区管理

# 设备传送驱动方式
即：控制**设备和内存/CPU 间的数据传送**
## 程序直接控制方式
由用户进程来直接控制内存或 CPU 和外围设备之间的信息传送。
这种方式的控制者是用户进程。

> CPU 和外围设备之间的信息传送。这种方式的控制者是用户进程。当用户进程需要数据时，它通过 CPU 发出启动设备准备数据的启动命令 Start,然后，用户进程进入测试等待状态。在等待时间内，CPU 不断地用一条测试指令检查描述外围设备的工作状态的控制状态寄存器。而外围设备只有将数据传送的准备工作做好之后，才将该寄存器置为完成状态。
> 从而，当 CPU 检测到控制状态寄存器为完成状态，也就是该寄存器发出 Done 信号之后，设备开始往内存或 CPU 传送数据。反之，当用户进程需要向设备输出数据时，也必须同样发启动命令启动设备和等待设备准备好之后才能输出数据。

**数据缓冲寄存器**
首先将数据送入寄存器，然后 CPU/外存再将数据取走。

**优点：**
简单，无需硬件支持

**缺点：**
CPU 和外设只能串行工作
CPU 一段时间内只能和一台外设交换信息
只适用于那些 CPU 执行速度慢，外围设备少的系统。

## 中断方式
**为了减少程序直接控制方式中 CPU 等待时间以及提高系统的并行工作速度。**
要求 CPU 与设备间有相应的中断允许位。

1.  进程需要数据时，通过 CPU 发出 start 指令启动外围设备准备数据。同时硬件开中断。——**需要数据请求**
2.  进程发出启动设备指令后，该进程放弃处理机，等待输入完成。进程调度程序或其他就绪进程占据处理机。
3.  输入完成时（或缓冲寄存器满时，这也就是经常进行中断操作的原因），IO 控制器通过中断请求线向 CPU 发出中断信号。CPU 收到后转向预先设置好的中断处理程序对数据传送工作进行处理。——**CPU 中断 处理传送完的数据**
4.  之后某时刻，进程调度程序选中提出请求并得到了数据的进程，该进程从相应的内存单元中取出数据继续工作。

进程与设备输入 异步执行。
实现了设备与设备间的并行操作以及设备和 CPU 间的并行操作。

**缺点**
- 数据缓冲寄存器一般较小，导致发生中断请求次数过多
- 外围设备多时，产生的中断请求很多。
- 数据可能会因为来不及从缓冲寄存器取走而丢失。

## DMA 方式
**在外围设备和内存之间开辟数据交换通路。**

IO 控制器具有比中断方式和程序直接控制方式更强的功能。
<u>因为 DMA 控制器在此时代替了 IO 控制器的作用，且更为强大和通用。解放了 CPU 的生产力。</u>

> 除了控制状态寄存器和数据缓冲寄存器之外，DMA 控制器中还包括传送字节计数器、内存地址寄存器等。这是因为 DMA 方式窃取或挪用 CPU 的一个工作周期把数据缓冲寄存器中的数据直接送到内存地址寄存器所指向的内存区域中的缘故。

DMA 控制器可用来带起 CPU 控制内存和设备之间进行成批数据交换。

**中断次数明显减少**
共中断 2 次
只需在数据块传送开始时需要 CPU 启动指令 以及 整个数据块传送结束时发中断通知

**处理过程**
- 当进程要求设备输入数据时，CPU 把一段内存的始址送入*DMA 控制器中的内存地址寄存器*；将传送的字节数送入*传送字节数计数器*。同时设备开中断。
- 发出数据要求的进程进入等待状态，进程调度程序调度其它进程占据 CPU
- 输入设备不断挪用 CPU 工作周期，将数据缓冲寄存器中的数据源源不断地写入内存。
- 传送完成后，DMA 控制器通过中断请求线发出中断信号。CPU 接到后转中断处理程序进行善后处理。
- 中断处理结束时，CPU 返回被中断进程处执行或被调度到新的上下文环境中。

写入缓冲寄存器的时候，满以后自动写入内存中等待。

![](https://pic3.zhimg.com/v2-232d505729039ca42b26c0414eaa1fd6_b.jpg)

## 通道控制方式
**以内存为中心，实现设备和内存直接交换数据的控制方式。**

DMA——CPU 控制
通道——专门的输入输出管理硬件：通道 控制

> 通道控制(channel control)方式与 DMA 方式相似，也是一种以内存为中心，实现设备和内存直接交换数据的控制方式。在 DMA 方式中，数据的传送方向、存放数据的内存始址以及传送的数据块长度等都由 CPU 控制，而在通道方式中，这些都由专管输入输出的硬件一通道来进行控制。另外，与 DMA 方式时每台设备至少一个 DMA 控制器相比，通道控制方式可以做到一个通道控制多台设备与内存进行数据交换，从而，通道方式进一步减轻了 CPU 的工作负担和增加了计算机系统的并行工作程度。

**通道**
是一个独立于 CPU 的专管输入输出控制的处理机，它控制设备与内存直接进行数据交换。它有自己的通道指令，这些通道指令由 CPU 启动，并在操作结束时向 CPU 发中断信号。

**通道指令**
一般包含被交换数据在内存中应占据的位置、传送方向、数据块长度以及被控制的 I/O 设备的地址信息、特征信息（例如是磁带设备还是磁盘设备）等，通道指令在通道中没有存储部件时存放在内存中。

一个通道可以以分时方式同时执行几个通道指令程序。按照信息交换方式的不同，一个系统中可设立 3 种类型的通道，即字节多路通道、数组多路通道和选择通道。

![](http://boluocat-tiku.oss-cn-shenzhen.aliyuncs.com/upload/image/20201013/20201013175252AA138277239711140068.jpg)

**处理过程**
- 当进程要求输入数据时，CPU 发 start 指明 IO 操作，设备号和对应通道
- 对应通道接受到 CPU 发来的启动指令后，把存放在内存中的通道指令程序读出，设置对应的 IO 控制器中的控制状态寄存器
- 设备根据通道指令要求，把数据送往内存中指定区域。
- 若数据传送结束，IO 控制器通过中断请求线发中断信号，请求 CPU 做中断处理。
- 与 DMA 方式时相同，即中断处理程序后 CPU 返回被中断进程处继续执行。

# 中断技术
> 中断(interrupt)是指计算机在执行程序期间，系统内发生任何非寻常的或非预期的急需处理事件，使得 CPU 暂时中断当前正在执行的程序而转去执行相应的事件处理程序，待处理完毕后又返回原来被中断处继续执行或调度新的进程执行的过程。引起中断发生的事件被称为中断源。中断源向 CPU 发出的请求中断处理信号称为中断请求，而 CPU 收到中断请求后转相应的事件处理程序称为中断响应。

**关中断——禁止中断**
CPU 内部的处理机状态字 PSW 的中断允许位已被清除，从而不允许 CPU 响应中断。但 CPU 内部的 PSW 中断位已被清除，从而不允许 CPU 响应中断。

**开中断**
PSW 的中断允许位的设置。

**开中断和关中断是为了保证程序执行的原子性**

**中断屏蔽**
在中断请求产生后，系统用软件方式有选择地封锁部分中断而允许其余部分的中断仍能得到响应。

## 中断的分类与优先级
根据中断产生的条件可分为内中断和外中断。
### 硬中断
#### 外中断
指定来自处理机和内存外部的中断，包括 IO 设备发出的 IO 中断。

==外中断在狭义上一般称为中断==

#### 内中断
主要指在处理机内和内存产生的中断。**内中断一般称作陷阱 trap**

联系到[[2 操作系统用户界面#陷阱（trap）处理机构]]。即系统调用如何处理内中断/陷阱。
***由于系统调用属于处理机内部操作，所以一定属于内中断即陷阱。***

> 包括程序运算引起的各种错误，如地址非法、校验错、页面失效、存取访问控制错、算术操作溢出、数据格式非法、除数为零、非法指令、用户程序执行特权指令、分时系统中的时间片中断以及从用户态到核心态的切换等都是陷阱的例子。

**OS 对不同的中断赋予不同的优先级**
目的：为了按中断源的轻重缓急处理响应中断。
e.g. UNIX 中，外中断和陷阱的优先级共分为 8 级。

**CPU 中的 PSW 也设有相应的优先级**
目的：为了禁止中断和屏蔽中断。
如果中断源请求高于 PSW 优先级，则 CPU 响应该请求；反之屏蔽该中断请求。

#### 中断和陷阱的区别
- 陷阱通常由处理机正在执行的现行指令引起，中断是由与现行指令无关的中断源引起的。
- **陷阱处理程序**提供的服务供当前进程使用；**中断处理程序**则不是。
- CPU 响应的时间不一样：两条指令的执行间隔响应中断；任意时刻可响应陷阱。

### 软中断
上述中断和陷阱都可以看做硬中断，**因为这些中断和陷阱要通过硬件产生相应的中断请求。**

软中断是通信进程之间用来模拟硬中断的一种信号通信方式。

**相同点**
CPU 接收进程在适当的时机自动进行中断处理 或 完成软中断信号对应的功能。

> 这里用“适当的时机”几个字是表示接收软中断信号的进程不一定正好在接收时占有处理机，而相应的处理必须等到该接收进程得到处理机之后才能进行。如果该接收进程是占据处理机的，与中断处理程序相同，立即执行该软中断信号对应的功能。

**在有些系统中，大部分的陷阱是转化为软中断处理。**
由于陷阱主要与当前执行进程有关，因此，如果当前执行指令产生陷阱的话，则向当前执行进程自身发出一个软中断信号从而立即进入陷阱处理程序。

<u>[[2 操作系统用户界面#陷阱（trap）处理机构]] 系统调用中，涉及到封装系统处理方法/进程，也就是用户进程与系统调用处理进程调用，传参，返回结果。这一系列便是两个进程间通信的极佳典范，也就能理解为什么陷阱要转为软中断处理。</u>

## 中断处理过程
一旦 CPU 响应中断，转入中断处理程序，OS 开始进行中断处理。

1.  CPU 检查响应中断条件是否满足。（主要是 CPU 允许中断）。
2.  若 CPU 响应中断，CPU 关中断，进入不可再次响应中断的状态。
3.  保存被中断的进程现场：PSW，PC
4.  分析中断原因，调用中断处理子程序。多个中断产生时，处理优先级最高的中断。 ^3604bc
5.  执行中断处理子程序。
6.  退出中断，恢复被中断进程的现场或调度新进程占据处理机。
7.  开中断，CPU 继续执行。

[[7 设备管理#^3604bc|mark4]]
> 在系统中，为了方便处理，通常都是针对不同的中断源编制有不同的中断处理子程序(陷阱处理子程序)。这些子程序的入口地址（或陷阱指令的入口地址）存放在内存的特定单元中。再者，不同的中断源也对应着不同的处理机状态字(PSW)。
>
> 这些不同的 PSW 被放在相应的内存单元中。存放的 PSW 与中断判断中断响应条件处理子程序入口地址一起构成**中断向量**。显然，根据中断或陷阱的种类，系统可由中断向量表迅速地找到该中断响应的优先级、中断关中断处理子程序（或陷阱指令）的入口地址和对应的 PSW。

中断向量的目的是为了更方便更准确地确定优先级。
# 缓冲技术
缓冲的引入原因：
**外围设备与 CPU 处理速度不匹配**

## 缓冲的分类
根据缓冲寄存器的个数分类。
### 单缓冲
设备之间无法仅通过一个缓冲器实现并行操作。

### 双缓冲
一种设备间，CPU 和设备并行操作的简单模型，不能用于实际系统中并行操作。

现代计算机中一般使用多缓冲或缓冲池结构。

### 多缓冲
多个缓冲器连接起来组成两部分：一部分专门用于输入，另一部分专门用于输出。

**缓冲池**
多个缓冲区连接起来统一管理，既可用于输入又可用于输出的缓冲结构。

## 缓冲池的管理
### 缓冲池结构
缓冲池由多个缓冲区组成。一个缓冲区由两部分组成：
标识和管理用的**缓冲首部**+存放数据的**缓冲体**。两部分一一对应。

对缓冲池的管理是通过对每一个缓冲器的缓冲首部进行操作实现的。

| 缓冲首部   |
| ---------- |
| 数据块号   |
| 缓冲器号   |
| 互斥标志位 |
| 连接指针   |

系统将缓冲区按使用情况连成 3 种队列：
1.  空白缓冲队列
2.  装满输入队列
3.  装满输出队列

### 缓冲池管理

# 设备分配
> 前面已经介绍了 I/O 数据传送控制方式及与其紧密相关的中断技术与缓冲技术。不过，在讨论这些问题时，已经做了如下假定：每一个准备传送数据的进程都已申请到了它所需要的外围设备、控制器和通道。事实上，由于设备、控制器和通道资源的有限性，不是每一个进程随时随地都能得到这些资源。进程必须首先向设备管理程序提出资源申请，然后，由设备分配程序根据相应的分配算法为进程分配资源。如果申请进程得不到它所申请的资源时，将被放入资源等待队列中等待，直到所需要的资源被释放。

## 设备分配用数据结构
**设备控制表 DCT**
反应设备特性，设备和 IO 控制器的连接情况。
系统中每个设备都必须有一张 DCT，在 OS 中生成时或设备连接时被创建。
但表中内容动态修改。

**系统设备表 SDT**
整个系统一张，记录已被连接到系统中所有物理设备的情况。并未每个物理设备设一个表项。

**控制器表 COCT**
每个控制器一张。反应 IO 控制器的使用状态以及和通道的连接情况等。
DMA 方式下没有。
*为什么 DMA 方式下没有？*
[[7 设备管理#DMA 方式]] DMA 控制器代替了 IO 控制器。此时没有。

*通道方式下有吗？*

## 设备分配原则
静态分配 动态分配

**设备分配策略**
1.  先请求先分配
2.  优先级高者分配

# IO 进程控制
> 前面各节在描述了 I/O 数据传送控制方式的基础上，讨论了中断、缓冲技术以及进行/O 数据传送所必需的设备分配策略与算法。那么，系统在何时分配设备，在何时申请缓冲，由哪个进程进行中断响应呢？另外，尽管 CPU 向设备或通道发出了启动指令，设备的启动以及 I/O 控制器中有关寄存器的值由谁来设置呢？这些都是前面几节的讨论中没有解决的问题。
## IO 控制的引入
*系统在何时分配设备，在何时申请缓冲，由哪个进程进行中断响应？*

*设备的启动及 IO 控制器中有关寄存器的值由谁来设置？*

## IO 控制的功能
**首先收集和分析调用 IO 控制过程的原因：**
外设来的中断请求 or 进程来的 IO 请求

根据不同的中断请求分类进行不同的处理。
根据不同的请求，分别调用不同的模块处理

**IO 请求处理**
是用户进程和设备管理程序接口的一部分，其把用户进程的 IO 请求变换为设备管理程序所能接受的信息。

首先将 IO 请求中的逻辑设备名转换为对应的物理设备名；
然后检查 IO 请求命令中是否有参数错误；
在 IO 请求中的逻辑设备名转换为对应的物理设备名；
检查 IO 请求命令中是否有参数错误；
启动设备分配程序。

**设备分配程序**
为 IO 请求分配了相应的设备、控制器和通道后，IO 控制器模块还将启动缓冲区管理模块为此次 IO 传送申请必要的缓冲区，以保证 IO 传送的顺利完成。
缓冲区的申请也可在设备分配之前进行。

**数据传送结束后**
外设发出中断请求，IO 控制过程将调用中断处理程序并做出中断响应。

## IO 控制的实现
**IO 控制过程的三种实现**
- 作为请求 IO 操作的进程一部分实现
- 作为当前进程一部分实现
- 由专门的系统进程——IO 进程完成

**IO 进程的三种实现**
- 每个设备设一个专门的 IO 进程，且只在系统态/核心态下运行
- 整个系统一个 IO 进程，全面负责系统数据传输工作。可以分为输入和输出进程
- 每个设备设一个专门的 IO 进程，可在核心态或用户态下运行

# 设备驱动程序
设备驱动程序是驱动物理设备和 DMA 控制器或 I/O 控制器等直接进行 I/O 操作的子程序的集合。它负责设置相应设备有关寄存器的值，启动设备进行 I/O 操作，指定操作的类型和数据流向等。

> 为了对设备驱动程序进行管理，系统中设置有设备开关表(Device Switch Table, DST)。设备开关表中给出相应设备的各种操作子程序，例如打开、关闭、读、写和启动设备子程序的入口地址。一般来说，设备开关表是二维结构，其中的行和列分别表示设备类型和驱动程序类型。设备开关表也是 I/O 进程的一个数据结构。I/O 控制过程为进程分配设备和缓冲区之后，可以使用设备开关表调用所需的设备驱动程序进行 I/O 操作。
