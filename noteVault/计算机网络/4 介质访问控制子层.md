# Intro
#第一遍阅读 
网络链路可以分为两大类：点到点连接和使用广播信道。MAC子层使用和广播网络相应的协议。

用来确定多路访问信道下一个使用者的协议属于数据链路层的一个子层,该层称为介质访问控制子层。在LAN中 ,MAC子层显得尤为重要,特别是在无线局域网中,因为无线本质上就是广播信道。
相反,WAN则使用点到点链路,当然,卫星网络除外。

因为多路访问信道和LAN如此紧密相关,所以,在本章我们将从总体上讨论LAN ,其中也包括一些从严格意义上讲并不属于MAC子层的内容,但是总的主题还是关于信道控制。

==**目的：决定多路访问信道的下一个使用者**==

**在数据链路层的底部**

# 信道分配问题 Channel Allocation

**- 静态信道分配**
在多个竞争用户之间分配单个信道的传统做法是把信道容量拆开分给多个用户使用，具体的方法可以采用物理层中的FDM（频分多路复用），就像多个竞争用户多路复用电话中继线一样。

**- 动态信道分配**
既然所有的传统静态信道分配方法都不适应突发性的流量,我们现在就来研究动态的信道分配方法。

==根据通讯特点来选择适合的方式，从而生出了动态的分配方式。==

## 动态信道分配假设 
1. 流量独立(independent traffic )。该模型是由N个独立的站(比如计算机、电话)组成的,每个站都有一个程序或者用户产生要传输的帧。一旦生成出一帧,则站就被阻塞,直到该帧被成功地发送出去。
2. 单信道。所有的通信都用这一个信道。所有站的能力相同。
3. 冲突可观察。如果两帧同时传输，则他们在时间上就重叠，由此产生的信号是混乱的，这种情况成为冲突。
4. 时间连续或分槽。时间可以假设是连续的，一个站在视图用信道之前就能知道该信道当前是否正被使用。
5. 载波侦听或不听。有了载波侦昕的假设,一个站在试图用信道之前就能知道该信道当前是否正被使用。如果信道侦昕结果是忙,则没有一个站会再去试图使用该信道。如果没有载波侦昕,站就无法在使用信道之前侦昕信道,它们只能盲目地传输,以后再判断这次传输是否成功。

# 多路访问协议 Multiple Access Protocol
## 纯ALOHA
纯ALOHA系统的基本思想非常简单:当用户有数据需要发送时就传输。当然,这样做可能会产生冲突,冲突的帧将被损坏。

如果帧被损坏了,则发送方要等待一段随机时间,然后再次发送该帧。

等待的时间必须是随机的,否则同样的帧会一次又一次地冲突,因为冲突帧被重发的节奏完全一致。如果系统中多个用户共享同一个信道的方法会导致冲突,则这样的系统称为竞争(contention) 系统。

==系统中所有的帧采用统一的长度。对于ALOHA来说，统一长度比长度可变更能达到最大吞吐量。==

无论何时,只要两个帧在相同时间试图占用信道,冲突就会发生(如图4 - 1所示),并且两帧都会被破坏。
如果新帧的第一位与几乎快传完的前一帧的最后一位重叠,则这两帧都将被彻底毁坏(即具有不正确的校验和),稍后都必须被重传。校验和不可能(也不应该)区分出是完全损坏还是局部差错。坏了就是坏了。

## 分槽ALOHA
ALOHA出现不久,Roberts发表了一种能将ALOHA系统的容量增加一倍的方法.他的建议是将时间分成离散的间隔,这种时间间隔称为时间槽(slot) , 每个时间槽对应于一帧。
这种方法要求用户遵守统一的**时间槽边界**。

取得同步时间的一种办法是由一个特殊的站在每个间隔起始时发出一个**脉冲信号**,就好像一个时钟一样。

分槽ALOHA中,站不允许用户每次敲入回车键就立即发送帧。相反,它必须要等到下一个时槽的开始时刻。**因此,连续的纯ALOHA变成了离散的ALOHA ,这将易受冲突期减小了一半。**

==让连续变为离散，使得ALOHA容量增加一倍==

## 载波侦听多路访问协议CSMA
站完全可以通过检测其他站在做什么，然后根据情况调整自己的行为，从而获得性能远高于ALOHA的协议。

### 1-坚持 CSMA
这是最简单的CSMA方案。当一个站有数据要发送时,它首先侦昕信道,确定当时是否有其他站正在传输数据:如果信道空闲,它就发送数据。否则,如果信道忙,该站等待直至信道变成空闲:然后,站发送一帧。如果发生冲突,该站等待一段随机的时间,然后再从头开始上述过程。

这样的协议之所以称为1 坚持,是因为当站发现信道空闲时,它传输数据的概率为1。


### 非坚持CSMA
第二个载波侦昕协议是非坚持CSMA(nonpersistent CSMA)。在这个协议中,站在试图发送数据之前要理智得多,不像前一个协议那样贪婪。和前一个协议一样,站在发送数据之前要先侦昕信道。如果没有其他站在发送数据,则该站自己开始发送数据。

然而,如果信道当前正在使用中,则该站并不持续对信道进行监听,以便传输结束后立即抓住机会发送数据。相反,它会等待一段随机时间,然后重复上述算法。因此，该算法将会导致更好地信道利用率，但也带来了更大的延迟。

### P-坚持CSMA
最后一个协议是p 一坚持C S M A( p-persistent CSMA)。它适用于分时间槽的信道,其工作方式如下所述。当一个站准备好要发送的数据时,它就侦昕信道。如果信道是空闲的,则它按照概率p发送数据:而以概率q = 1-p ,将此次发送推迟到下一个时间槽。如果下一个时间槽信道也是空闲的,则它还是以概率p发送数据,或者以概率q再次推迟发送。

### CSMA/CD
即带冲突检测的CSMA

**实现细节**
如同许多其他LAN协议一样,CSMA/CD也使用了图4 - 5 所示的概念模型。在标记为句点,一个站己经完成了帧的传送,其他需要发送帧的站现在可以试图发送了。如果有两个或者多个站同时进行传送,冲突就会发生。如果一个站检测到冲突,它立即中止自己的传送,等待一段随机时间,然后再重新尝试传送(假定在此期间没有其他站己经开始传送）。

因此,我们的CSMA/CD模型将由交替出现的竞争期、传输期,以及当所有站都静止的空闲期（比如没有传输任务）组成。


***是否抓住了信道？***
检测冲突的最小时间恰好是将信号从一个站传播到另一个站所需要的时间。
基于这个信息,你可能会认为一个站在开始发送后,经过一段特定的时间还未监听到冲突,它就可以确定自己“抓住”(seize)了电缆。

**只有当一个站传输了2t（2倍最远信号传递之间）之后还没有检测到冲突，它才可以保证自己抓住了信道。**

==1坚持：贪婪且较为浪费资源==
==非坚持等：增加了信道利用率，延迟增大==
==CSMA/CD：发送的同时继续监听 检测到冲突停止发送 竞争期传输期交替出现==

## 无冲突协议

### 位图协议

### Token传递
完成同样事情的另一种方法是通过传递一个称为令牌(token)的短消息,该令牌同样也是以预定义的顺序从一个站传到下一个站。令牌代表了发送权限。如果站有个等待传输的帧队列,当它接收到令牌就可以发送帧,然后再把令牌传递到下一站。如果它没有排队的帧要传,则它只是简单地把令牌传递下去。

在令牌环协议中,网络的拓扑结构被用来定义站的发送顺序。所有站连接成一个单环结构,一个站依次连接到下一个站。因此令牌传递到下一站只是单纯地从一个方向上接收令牌和在另一个方向上发送令牌。帧也按令牌方向传输。

**只有拿到token的站才有能力发送信号。**

## 无线局域网协议
**隐藏终端问题**
由于竞争者离得太远而导致站无法检测到潜在的竞争者。 ^36777f

**暴露终端问题**
由于竞争者离得太近导致检测错误而无法正常发送。

### 冲突避免多路访问协议 MACA
在无线情况下代替CSMA

利用发送短帧RTS，CTS，以便使附近的站能检测到该次传输，从而避免接下去进行较大数据帧传输中也发送数据。

如果一个站听到了RTS帧,那么它一定离A很近,它必须保持沉默,至少等待足够长的时间以便在无冲突情况下CTS被返回给A。
如果一个站昕到了CTS,则它一定离B很近,在接下来的数据传送过程中它必须一直保持沉默,只要检查CTS帧,该站就可以知道数据帧的长度(即数据传输要持续多久)。



# 以太网-实例
我们将开始研究太网网实际系统,这可能是现实世界中最普遍的一种计算机网络。以太网有两类:第一类是经典以太网(classic Ethernet),它使用我们在本章己学过的技术解决了多路访问问题:第二类是交换式以太网(switched Ethernet),使用了一种称为交换机的设备连接不同的计算机。

经典以太网是指以太网的原始形式，运行速度从3~10Mbps不等。
交换式以太网则是成就了以太网的网络形式。速率快，分别以快速以太网，千兆以太网和万兆以太网形式呈现。

## 经典以太网
### Classic Ethernet物理层

### Classic Ethernet MAC子层协议
**以太网（DIX）：**

| 前导码 | 目标地址 | 源地址 | 类型 | 数据   | 填充 | 校验和 |
| ------ | -------- | ------ | ---- | ------ | ---- | ------ |
| 8      | 6        | 6      | 2    | 0-1500 | 0-46 | 4       |

**最小帧长度限制**
*Padding*
为了更加容易地区分有效帧和垃圾数据,以太网要求有效帧必须至少64字节长,从目标地址算起直到校验和,包括这两个字段本身在内。如果帧的数据部分少于46个字节,则使用填充(Pad)字段来填充该帧,使其达到最小长度要求。

*短帧问题*
限制最小帧长的另一个（也是更重要的）理由是避免出现这样的情况:当一个短帧还没有到达电缆远端的发送方,该帧的传送就已经结束:而在电缆的远端,该帧可能与另一帧发生冲突。

**校验和 checksum**
最后一个字段是校验和。它是我们在3. 2 节学过的3 2 位CRC。
事实上,它由我们曾经给出的生成多项式确切定义,这个CRC同样被用于PPP、ADSL和其他链路层协议。
CRC是差错检测码,用来确定接收到的帧比特是否正确。它只提供检错功能,如果检测到一个错误,则丢弃帧。


## 交换式以太网
**从集线器到交换机**
集线器不增加容量，因为他们逻辑上等同于单根电缆的Classic Ethernet

幸运的是,还有另一条出路可以处理不断增长的负载:即交换式以太网。
这种系统的核心是一个交换机(switch),它包含一块连接所有端口的高速背板。从外面看,交换机很像集线器。它们都是一个盒子,通常拥有4 ~4 8 个端口,每个端口都有一个标准的R J - 4 5连接器用来连接双绞线电缆。

*如果有多个站或者端口都要传送数据，会发生什么情况？*
在这点上,交换机再一次体现了与集线器的不同。在集线器中,所有站都位于同一个冲突域C collision domain), 它们必须使用CSMA/CD算法来调度各自的传输。在交换机中,每个端口有自己独立的冲突域。通常情况下,电缆是全双工的,站和端口可以同时往电缆上发送帧,根本无须担心其他站或者端口。现在冲突不可能发生,因而CSMA/CD也就不需要了。然后,如果电缆是半双工的,则站和端口必须以通常的CSMA/CD方式竞争传输。

**交换机性能**
交换机的性能优于集线器有两方面的原因。
首先,由于没有冲突,容量的使用更为有效。
其次,也是更重要的,有了交换机可以同时发送多个帧（由不同的站发出）。

这些帧到达交换机端口井穿过交换机背板输出到适当的端口。然而,由于两帧可能在同一时间去往同一个输出端口,交换机必须有缓冲,以便它暂时把输入帧排入队列直到帧被传输到输出端口。
总体而言,这些改进获得了较大的性能改进,而这些改进手段对于集线器来说又是不可能做到的。系统总吞吐量通常可以提高一个数量级,主要取决于端口数目和流量模式。

# 无线局域网
## 802.11体系结构与协议栈
**分布式系统**
即有架构模式。每个客户端与一个AP关联，该AP又与其他网络连接。几个接入点可通过一个分布式系统的有线网络连接在一起，形成一个扩展的802.11网络。

**ad hoc自组织网络**
网络由一组相互关联的计算机组成，它们之间可以直接向对方发送帧。这里没有直接的AP。

**协议**
所有802协议（802.11和Ethernet）都有某些结构上的共性。

- 客户端和AP协议栈相同。物理层对应于OSI的物理层。
- MAC子层决定如何分配信道。在其上方的是逻辑链路控制LLC子层。它的作用是隐藏802系列协议之间的差异，使他们在网络层看起来并无差别。

*正交频分复用 OFDM*

## 802.11 MAC子层协议
> 首先,无线电几乎总是半双工的,这意味着它们不能在一个频率上传输的同时侦昕该频率上的突发噪声。接收到的信号很容易变得比发射信号弱上一百万倍,因此它无法在同一时间昕到这么微弱的信号。而在以太网中,一个站只要等到介质空闲,然后开始传输。
> 如果它没有在发送的前64个字节期间收到返回的突发噪声,则几乎可以肯定帧能正确地传送出去。

对于无线介质,这种冲突检测机制根本不起作用。

相反，802.11试图避免冲突，采用的协议为带有冲突避免的CSMA。即CSMA/CA

**和以太网相比,这里有两个主要区别：**
首先,早期的后退有助于避免冲突。冲突避免在无线传输中非常重要,即使只发生一个冲突因为整个帧都被传输了出去,因此冲突的代价非常昂贵。
其次,利用确认来推断是否发生冲突,因为冲突无法被检测出来。

[[#^36777f|隐藏终端与暴露终端问题又会出现]]。利用RTS与CTS解决。

为了减少究竟哪个站在发送的模糊不清,802.11定义信道侦听包括物理侦听和虚拟侦昕两部分。
物理侦昕只是简单地检查介质,看是否存在有效的信号:有了虚拟侦昕,每个站可以保留一个信道何时要用的逻辑记录,这是通过跟踪网络分配向量(NAV ,Network Allocation Vector)获得的。

每个帧携带一个N A V宇段,说明这个帧所属的一系列数据将传输多长时间。无意中听到这个帧的站就知道无论自己是否能够侦听到物理信号,由N A V 所指出的时间段信道一定是繁忙的。例如,一个数据帧的N A V给出了发送一个确认所需要的时间。所有听到该数据帧的站将在发送确认期间推迟发送,而不管它们是否能昕到确认的发送。

## 802.11帧结构


# 数据链路层交换DataLink Layer Switching
将多个局域网连接在一起。

事实上,当我们采用称为网桥(bridge)的设备来连接这些局域网就可以做到这一点。
在之前描述的以太网交换机是网桥的现代名称:它们提供的功能超越了传统的以太网和以太网集线器,可以很容易地把多个局域网加入到一个更大更快的网络上。
我们将交替着使用术语“网桥”和“交换机
## Bridge
*为什么要使用多个LAN*

### 学习网桥

### 生成树网桥

## 中继器/集线器/网桥/交换机/路由器和网关
**设备的工作层次**

| layer      | device        |
| ---------- | ------------- |
| 应用层     | 应用网关      |
| 传输层     | 传输网关      |
| 网络层     | 路由器        |
| 数据链路层 | 网桥 交换机   |
| 物理层     | 中继器 集线器 |

**帧，数据包和头**

| 帧头 | 数据包头 | TCP头 | 用户数据 | CRC | 
| ---- | -------- | ----- | -------- | --- |

# 小结
如何在希望使用信道的竞争站点间分配信道

==MAC子层——解决信道分配问题==


# Q&A
- mac层为什么位于数据链路层下部 子层-属于数据链路层

- 信道分配的方法分类 和生活中的例子

- 计算机网络是用动态好还是静态好？

- ALOHA是静态or动态？基本的原理是什么？

- 分槽ALOHA为什么性能好？

- 如何进一步减少冲突？

- 有没有没有冲突的协议 

- 解释隐藏终端

- 解释暴露终端的导致

- 以太网的分类 它们之间的介质访问控制协议是一样的吗？

- 经典以太网mac层用什么协议

- 为什么经典以太网要求所有数据帧用2倍t来传输

- CSMA/CA冲突避免的方式

- CSMA/CA通常采用什么方式来判断是否发生冲突

- 网桥的主要作用是什么？是哪一层的网络内容？

- Learning Bridges 的ppt 网桥扩展数据链路层 [下面两句话的理解](x-devonthink-item://2B538969-8AD9-4DD1-93F6-105D8C4750CF?page=65) 说明什么意思
